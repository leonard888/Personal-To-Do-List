<!DOCTYPE html>
<html lang="id" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Personal Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            scroll-behavior: smooth;
        }
        /* Menggunakan dark mode dari OS */
        @media (prefers-color-scheme: dark) {
            html {
                color-scheme: dark;
            }
        }
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        /* Style untuk dialog/modal backdrop */
        dialog::backdrop {
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(2px);
        }
        /* Loading spinner */
        .loader {
            border-top-color: #3498db;
            -webkit-animation: spin 1s linear infinite;
            animation: spin 1s linear infinite;
        }
        @-webkit-keyframes spin {
            0% { -webkit-transform: rotate(0deg); }
            100% { -webkit-transform: rotate(360deg); }
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Style untuk chart yang bisa di-resize */
        .resizable-chart-container {
            resize: vertical;
            overflow: auto;
            min-height: 300px;
            max-height: 800px;
            border: 1px solid #4B5563; /* dark:border-gray-600 */
            border-radius: 0.5rem; /* rounded-lg */
        }

        /* --- Kalender --- */
        #calendarGrid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background-color: #4b5563; /* bg-gray-600 */
            border: 1px solid #4b5563; /* bg-gray-600 */
        }
        .calendar-day-header {
            font-size: 0.75rem; /* text-xs */
            font-weight: 600; /* font-semibold */
            text-align: center;
            padding: 0.5rem; /* p-2 */
            background-color: #374151; /* bg-gray-700 */
            color: white;
        }
        .calendar-day {
            position: relative;
            min-height: 100px;
            padding: 0.5rem; /* p-2 */
            background-color: #fff; /* bg-white */
            dark:background-color: #1f2937; /* dark:bg-gray-800 */
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .calendar-day:hover {
            background-color: #f3f4f6; /* hover:bg-gray-100 */
            dark:background-color: #374151; /* dark:hover:bg-gray-700 */
        }
        .calendar-day.other-month {
            background-color: #f9fafb; /* bg-gray-50 */
            dark:background-color: #111827; /* dark:bg-gray-900 */
            color: #9ca3af; /* text-gray-400 */
            cursor: default;
        }
        .calendar-day .day-number {
            font-size: 0.875rem; /* text-sm */
            font-weight: 500; /* font-medium */
        }
        .calendar-day.today .day-number {
            background-color: #2563eb; /* bg-blue-600 */
            color: white;
            border-radius: 50%;
            width: 1.75rem; /* w-7 */
            height: 1.75rem; /* h-7 */
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        .event-dot-container {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            margin-top: 0.5rem; /* mt-2 */
        }
        .event-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
        }
        .event-dot-task { background-color: #eab308; } /* yellow-500 */
        .event-dot-event { background-color: #8b5cf6; } /* violet-500 */
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-gray-100 h-full overflow-hidden">

    <!-- Global Loading Overlay -->
    <div id="loadingOverlay" class="absolute inset-0 bg-gray-100 dark:bg-gray-900 flex items-center justify-center z-50">
        <div class="loader ease-linear rounded-full border-8 border-t-8 border-gray-200 h-32 w-32"></div>
        <p class="mt-4 text-lg">Memuat Dashboard...</p>
    </div>

    <!-- Login Screen -->
    <div id="loginScreen" class="hidden h-full flex items-center justify-center">
        <div class="bg-white dark:bg-gray-800 p-8 rounded-lg shadow-xl w-full max-w-sm text-center">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-16 h-16 text-blue-600 dark:text-blue-500 mx-auto mb-4">
                <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 3v18h18V3H3.75zM9 9h6m-6 4h6m-6 4h6" />
            </svg>
            <h1 class="text-2xl font-bold mb-2">Personal Dashboard</h1>
            <p class="text-gray-600 dark:text-gray-400 mb-6">Silakan login untuk melanjutkan.</p>
            <button id="loginWithGoogleBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 px-4 rounded-lg flex items-center justify-center">
                <svg class="w-5 h-5 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M20.283 10.356h-8.327v3.451h4.792c-.446 2.193-2.313 3.453-4.792 3.453a5.27 5.27 0 01-5.279-5.28 5.27 5.27 0 015.279-5.279c1.259 0 2.397.447 3.29 1.178l2.6-2.599A8.98 8.98 0 0011.956 2a9 9 0 100 18c5.04 0 8.79-3.67 8.79-8.79 0-.613-.056-1.227-.163-1.831z" />
                </svg>
                Login dengan Google
            </button>
            <p id="loginError" class="text-red-500 text-sm mt-4 hidden"></p>
        </div>
    </div>

    <!-- Main Application (Hidden by default) -->
    <div id="mainApp" class="hidden h-full">
        <div class="flex h-full w-full">
            <!-- Sidebar Navigation -->
            <nav class="w-20 md:w-64 bg-white dark:bg-gray-800 shadow-lg flex flex-col">
                <div class="p-4 md:p-6 flex items-center justify-center md:justify-start">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8 text-blue-600 dark:text-blue-500">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 3v18h18V3H3.75zM9 9h6m-6 4h6m-6 4h6" />
                    </svg>
                    <span class="hidden md:block ml-3 text-xl font-bold">Dashboard</span>
                </div>
                <ul class="flex-1 mt-6 space-y-2 px-2 md:px-4">
                    <li>
                        <button data-tab="dashboard" class="nav-tab w-full flex items-center p-3 rounded-lg text-white bg-blue-600 dark:bg-blue-500 font-medium">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M10.5 6a7.5 7.5 0 100 15 7.5 7.5 0 000-15z" /><path stroke-linecap="round" stroke-linejoin="round" d="M12 10.5v3.75m0-3.75a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                            <span class="hidden md:block ml-4">Dashboard</span>
                        </button>
                    </li>
                    <li>
                        <button data-tab="wishlist" class="nav-tab w-full flex items-center p-3 rounded-lg text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-700">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 3h1.386c.51 0 .955.343 1.087.835l.383 1.437M7.5 14.25a3 3 0 00-3 3h15.75m-12.75-3h11.218c1.121-2.3 2.1-4.684 2.924-7.138a60.114 60.114 0 00-16.536-1.84M7.5 14.25L5.106 5.772M6 20.25a.75.75 0 11-1.5 0 .75.75 0 011.5 0zM18 20.25a.75.75 0 11-1.5 0 .75.75 0 011.5 0z" /></svg>
                            <span class="hidden md:block ml-4">Wishlist</span>
                        </button>
                    </li>
                    <!-- Tombol Tab Gemini Dihapus untuk menghemat ruang -->
                </ul>
                <div class="p-4 mt-auto">
                    <!-- Tombol Open Gemini (Browser) -->
                    <a href="https://gemini.google.com" target="_blank" rel="noopener noreferrer" class="w-full text-sm flex items-center justify-center md:justify-start p-2 rounded-lg text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-700 mb-2">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09zM18.259 8.715L18 9.75l-.259-1.035a3.375 3.375 0 00-2.457-2.457L14.25 6l1.036-.259a3.375 3.375 0 002.457-2.457L18 2.25l.259 1.035a3.375 3.375 0 002.457 2.457L21.75 6l-1.036.259a3.375 3.375 0 00-2.457 2.457z" />
                        </svg>
                        <span class="hidden md:block ml-2">Buka Gemini</span>
                    </a>
                    <!-- User Info & Logout Button -->
                    <div id="authStatus" class="flex flex-col items-center md:items-start">
                        <div class="flex items-center mb-2">
                            <img id="userAvatar" src="" alt="Avatar" class="w-8 h-8 rounded-full mr-2">
                            <span id="userName" class="hidden md:block text-sm font-medium"></span>
                        </div>
                        <button id="logoutBtn" class="w-full text-sm flex items-center justify-center md:justify-start p-2 rounded-lg text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-700">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 9V5.25A2.25 2.25 0 0013.5 3h-6a2.25 2.25 0 00-2.25 2.25v13.5A2.25 2.25 0 007.5 21h6a2.25 2.25 0 002.25-2.25V15m3 0l3-3m0 0l-3-3m3 3H9" />
                            </svg>
                            <span class="hidden md:block ml-2">Logout</span>
                        </button>
                    </div>
                </div>
            </nav>

            <!-- Main Content -->
            <main class="flex-1 overflow-y-auto p-4 md:p-8">
                <!-- Wrapper untuk Jam dan Konten -->
                <div>
                    <!-- Jam dan Hari (Layout diperbaiki) -->
                    <div class="flex justify-end mb-4">
                        <div id="clockDate" class="text-right text-sm md:text-base font-medium text-gray-700 dark:text-gray-300">
                            <div id="clockEl">00:00:00</div>
                            <div id="dateEl">Kamis, 1 Jan 1970</div>
                        </div>
                    </div>

                    <!-- Dashboard Tab -->
                    <div id="dashboard" class="tab-content space-y-6">
                        <!-- Stock Market Section -->
                        <section>
                            <h2 class="text-2xl font-bold mb-4">Market Overview</h2>
                            <!-- TradingView Ticker Tape Widget -->
                            <div class="tradingview-widget-container">
                                <div class="tradingview-widget-container__widget"></div>
                                <script type="text/javascript" src="https://s3.tradingview.com/external-embedding/embed-widget-ticker-tape.js" async>
                                {
                                "symbols": [
                                    { "proName": "IDX:COMPOSITE", "title": "IHSG" },
                                    { "proName": "IDX:BBCA", "title": "BBCA" },
                                    { "proName": "IDX:BBRI", "title": "BBRI" },
                                    { "proName": "IDX:TLKM", "title": "TLKM" },
                                    { "proName": "IDX:ASII", "title": "ASII" }
                                ],
                                "showSymbolLogo": true, "colorTheme": "dark", "isTransparent": false, "displayMode": "adaptive", "locale": "id"
                                }
                                </script>
                            </div>
                            <!-- TradingView Chart Widget -->
                            <div class="tradingview-widget-container mt-4 resizable-chart-container" style="height:400px; width:100%;">
                                <div id="tradingview_chart" style="height:100%; width:100%;"></div>
                                <script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
                                <script type="text/javascript">
                                    new TradingView.widget({
                                        "width": "100%", "height": "100%", "symbol": "IDX:COMPOSITE", "interval": "D",
                                        "timezone": "Asia/Jakarta", "theme": "dark", "style": "1", "locale": "id",
                                        "enable_publishing": false, "allow_symbol_change": true, "container_id": "tradingview_chart"
                                    });
                                </script>
                            </div>
                        </section>

                        <!-- Upcoming Events Section (Menggantikan Repeated Task) -->
                        <section id="upcomingEventsSection">
                            <div class="flex justify-between items-center mb-4">
                                <h2 class="text-2xl font-bold">Event & Task Mendatang (Hari Ini)</h2>
                            </div>
                            <div id="upcomingEventsList" class="space-y-3">
                                <!-- Upcoming event items akan ditambahkan di sini oleh JavaScript -->
                                <p id="noUpcomingEvents" class="text-center text-gray-500 dark:text-gray-400 bg-white dark:bg-gray-800 p-4 rounded-lg shadow-md">Tidak ada event atau task yang jatuh tempo saat ini.</p>
                            </div>
                        </section>

                        <!-- To-Do List Section -->
                        <section class="mt-6"> 
                            <div class="flex justify-between items-center mb-4">
                                <h2 class="text-2xl font-bold">To-Do List</h2>
                                <button id="showTaskModal" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg flex items-center">
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 mr-2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" /></svg>
                                    Tambah Task
                                </button>
                            </div>

                            <!-- Task Status Chart & Dashboard -->
                            <div class="grid grid-cols-1 lg:grid-cols-5 gap-6 mb-6">
                                <!-- Chart -->
                                <div class="lg:col-span-2 bg-white dark:bg-gray-800 p-4 rounded-lg shadow-md h-64 relative">
                                    <h4 class="text-lg font-semibold text-center mb-2">Visualisasi Status Task</h4>
                                    <canvas id="taskStatusChart"></canvas>
                                </div>
                                
                                <!-- Cards -->
                                <div class="lg:col-span-3 grid grid-cols-2 md:grid-cols-3 gap-4">
                                    <div id="filterAll" class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow-md cursor-pointer filter-card transition-all duration-200">
                                        <h4 class="text-sm font-medium text-gray-700 dark:text-white">Total Tasks</h4>
                                        <p id="totalTasks" class="text-3xl font-bold text-gray-900 dark:text-white">0</p>
                                    </div>
                                    <div id="filterPending" class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow-md cursor-pointer filter-card transition-all duration-200">
                                        <h4 class="text-sm font-medium text-gray-700 dark:text-white">Pending</h4>
                                        <p id="pendingTasks" class="text-3xl font-bold text-yellow-500">0</p>
                                    </div>
                                    <div id="filterInProgress" class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow-md cursor-pointer filter-card transition-all duration-200">
                                        <h4 class="text-sm font-medium text-gray-700 dark:text-white">In Progress</h4>
                                        <p id="inProgressTasks" class="text-3xl font-bold text-blue-500">0</p>
                                    </div>
                                    <div id="filterCompleted" class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow-md cursor-pointer filter-card transition-all duration-200">
                                        <h4 class="text-sm font-medium text-gray-700 dark:text-white">Completed</h4>
                                        <p id="completedTasks" class="text-3xl font-bold text-green-500">0</p>
                                    </div>
                                    <div id="filterDeadline" class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow-md ring-2 ring-transparent cursor-pointer filter-card transition-all duration-200">
                                        <h4 class="text-sm font-medium text-gray-700 dark:text-white">Mendekati Deadline</h4>
                                        <p id="deadlineWarning" class="text-3xl font-bold text-red-500">0</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Task List -->
                            <div id="taskList" class="space-y-4">
                                <!-- Task items akan ditambahkan di sini oleh JavaScript -->
                                <p id="noTasks" class="text-center text-gray-500 dark:text-gray-400">Belum ada task. Silakan tambahkan!</p>
                            </div>
                        </section>

                        <!-- Kalender Section -->
                        <section id="calendarSection" class="mt-6">
                            <div class="flex justify-between items-center mb-4">
                                <h2 class="text-2xl font-bold">Kalender</h2>
                                <div class="flex items-center gap-4">
                                    <div class="flex items-center gap-2 text-xs">
                                        <span class="event-dot event-dot-task"></span> Task
                                        <span class="event-dot event-dot-event ml-2"></span> Event
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <button id="prevMonth" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700">
                                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5L8.25 12l7.5-7.5" /></svg>
                                        </button>
                                        <h3 id="currentMonthYear" class="text-lg font-semibold w-32 text-center"></h3>
                                        <button id="nextMonth" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700">
                                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M8.25 4.5l7.5 7.5-7.5 7.5" /></svg>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md overflow-hidden">
                                <div id="calendarDayHeaders" class="grid grid-cols-7">
                                    <div class="calendar-day-header">Min</div>
                                    <div class="calendar-day-header">Sen</div>
                                    <div class="calendar-day-header">Sel</div>
                                    <div class="calendar-day-header">Rab</div>
                                    <div class="calendar-day-header">Kam</div>
                                    <div class="calendar-day-header">Jum</div>
                                    <div class="calendar-day-header">Sab</div>
                                </div>
                                <div id="calendarGrid">
                                    <!-- Sel-sel kalender akan di-generate oleh JS -->
                                </div>
                            </div>
                        </section>
                    </div>

                    <!-- Wishlist Tab -->
                    <div id="wishlist" class="tab-content hidden space-y-6">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <h2 class="text-2xl font-bold">Wishlist Belanja</h2>
                                <!-- Total Harga Wishlist -->
                                <div class="flex items-baseline gap-2 mt-1">
                                    <h3 class="text-sm font-medium text-gray-500 dark:text-gray-400">Total Estimasi:</h3>
                                    <p id="wishlistTotal" class="text-xl font-bold text-blue-600 dark:text-blue-400">Rp 0</p>
                                </div>
                            </div>
                            <button id="showWishlistModal" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 mr-2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" /></svg>
                                Tambah Barang
                            </button>
                        </div>
                        <div id="wishlistGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            <!-- Wishlist items akan ditambahkan di sini -->
                            <p id="noWishlistItems" class="text-center text-gray-500 dark:text-gray-400 col-span-full">Belum ada barang di wishlist.</p>
                        </div>
                    </div>

                    <!-- Gemini Tab (Dihapus) -->

                </div>
            </main>
        </div>
    </div>

    <!-- Task Modal -->
    <dialog id="taskModal" class="p-0 rounded-lg shadow-xl w-full max-w-md bg-white dark:bg-gray-800">
        <form id="taskForm" class="p-6 space-y-4">
            <h3 class="text-xl font-medium">Tambah Task Baru</h3>
            <div id="taskError" class="hidden text-sm text-red-500 bg-red-100 dark:bg-red-900 dark:text-red-200 p-3 rounded-md"></div>
            <div>
                <label for="taskName" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Nama Task</label>
                <input type="text" id="taskName" name="taskName" class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 shadow-sm focus:border-blue-500 focus:ring-blue-500 dark:bg-gray-700">
            </div>
            <div>
                <label for="taskNotes" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Notes</label>
                <textarea id="taskNotes" name="taskNotes" rows="3" class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 shadow-sm focus:border-blue-500 focus:ring-blue-500 dark:bg-gray-700"></textarea>
            </div>
            <div>
                <label for="taskDriveLink" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Link Google Drive</label>
                <input type="url" id="taskDriveLink" name="taskDriveLink" placeholder="https://..." class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 shadow-sm focus:border-blue-500 focus:ring-blue-500 dark:bg-gray-700">
            </div>
            <div>
                <label for="taskStatus" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Status</label>
                <select id="taskStatus" name="taskStatus" class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 shadow-sm focus:border-blue-500 focus:ring-blue-500 dark:bg-gray-700">
                    <option value="pending">Pending</option>
                    <option value="in-progress">In Progress</option>
                    <option value="completed">Completed</option>
                </select>
            </div>
            <!-- PERUBAHAN: Input Tanggal dan Jam untuk Task -->
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label for="taskDeadline" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Deadline</label>
                    <input type="date" id="taskDeadline" name="taskDeadline" class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 shadow-sm focus:border-blue-500 focus:ring-blue-500 dark:bg-gray-700">
                </div>
                <div>
                    <label for="taskTime" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Jam (Opsional)</label>
                    <input type="time" id="taskTime" name="taskTime" class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 shadow-sm focus:border-blue-500 focus:ring-blue-500 dark:bg-gray-700">
                </div>
            </div>
            <div class="flex justify-end space-x-3 pt-4">
                <button type="button" id="closeTaskModal" class="bg-gray-200 hover:bg-gray-300 dark:bg-gray-600 dark:hover:bg-gray-500 text-gray-800 dark:text-gray-200 font-medium py-2 px-4 rounded-lg">Batal</button>
                <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg">Simpan</button>
            </div>
        </form>
    </dialog>

    <!-- Wishlist Modal -->
    <dialog id="wishlistModal" class="p-0 rounded-lg shadow-xl w-full max-w-md bg-white dark:bg-gray-800">
        <form id="wishlistForm" class="p-6 space-y-4">
            <h3 class="text-xl font-medium">Tambah Barang Wishlist</h3>
            <div>
                <label for="productName" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Nama Produk</label>
                <input type="text" id="productName" name="productName" required class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 shadow-sm focus:border-blue-500 focus:ring-blue-500 dark:bg-gray-700">
            </div>
            <div>
                <label for="productLink" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Link Tokopedia/Shopee</label>
                <input type="url" id="productLink" name="productLink" placeholder="https://..." class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 shadow-sm focus:border-blue-500 focus:ring-blue-500 dark:bg-gray-700">
            </div>
            <div>
                <label for="productPrice" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Perkiraan Harga</label>
                <input type="number" id="productPrice" name="productPrice" min="0" placeholder="100000" class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 shadow-sm focus:border-blue-500 focus:ring-blue-500 dark:bg-gray-700">
            </div>
            <div class="flex justify-end space-x-3 pt-4">
                <button type="button" id="closeWishlistModal" class="bg-gray-200 hover:bg-gray-300 dark:bg-gray-600 dark:hover:bg-gray-500 text-gray-800 dark:text-gray-200 font-medium py-2 px-4 rounded-lg">Batal</button>
                <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg">Simpan</button>
            </div>
        </form>
    </dialog>

    <!-- Event Modal (dari Kalender) -->
    <dialog id="eventModal" class="p-0 rounded-lg shadow-xl w-full max-w-md bg-white dark:bg-gray-800">
        <form id="eventForm" class="p-6 space-y-4" data-event-id="">
            <h3 id="eventModalTitle" class="text-xl font-medium">Tambah Event Baru</h3>
            <div id="eventError" class="hidden text-sm text-red-500 bg-red-100 dark:bg-red-900 dark:text-red-200 p-3 rounded-md"></div>
            
            <div>
                <label for="eventName" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Nama Event</label>
                <input type="text" id="eventName" name="eventName" class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 shadow-sm focus:border-blue-500 focus:ring-blue-500 dark:bg-gray-700">
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label for="eventDate" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Tanggal</label>
                    <input type="date" id="eventDate" name="eventDate" class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 shadow-sm focus:border-blue-500 focus:ring-blue-500 dark:bg-gray-700" readonly>
                </div>
                <div>
                    <label for="eventTime" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Jam</Tlabel>
                    <input type="time" id="eventTime" name="eventTime" class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 shadow-sm focus:border-blue-500 focus:ring-blue-500 dark:bg-gray-700">
                </div>
            </div>

            <div>
                <label for="eventRepeat" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Berulang</label>
                <select id="eventRepeat" name="eventRepeat" class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 shadow-sm focus:border-blue-500 focus:ring-blue-500 dark:bg-gray-700">
                    <option value="once">Sekali Saja</option>
                    <option value="daily">Setiap Hari</option>
                    <option value="weekly">Setiap Minggu (di hari ini)</option>
                </select>
            </div>

            <div class="flex justify-between space-x-3 pt-4">
                <button type="button" id="deleteEventBtn" class="hidden bg-red-600 hover:bg-red-700 text-white font-medium py-2 px-4 rounded-lg">Hapus</button>
                <div class="flex-1 flex justify-end gap-3">
                    <button type="button" id="closeEventModalBtn" class="bg-gray-200 hover:bg-gray-300 dark:bg-gray-600 dark:hover:bg-gray-500 text-gray-800 dark:text-gray-200 font-medium py-2 px-4 rounded-lg">Batal</button>
                    <button type="submit" class="bg-purple-600 hover:bg-purple-700 text-white font-medium py-2 px-4 rounded-lg">Simpan</button>
                </div>
            </div>
        </form>
    </dialog>


    <!-- Firebase SDK -->
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            onAuthStateChanged,
            GoogleAuthProvider,
            signInWithPopup,
            signOut
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            setDoc, 
            addDoc, 
            deleteDoc, 
            updateDoc, 
            collection, 
            onSnapshot,
            serverTimestamp,
            getDoc,
            query
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase Configuration ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        
        // ======================================================================
        // KONFIGURASI UNTUK LOKAL / GITHUB PAGES
        // ======================================================================
        const firebaseConfig = {
            apiKey: "AIzaSyCiIZRywKs7nF92z6_FWMzhOAaRe9SOOJE",
            authDomain: "personal-to-do-list-5d959.firebaseapp.com",
            projectId: "personal-to-do-list-5d959",
            storageBucket: "personal-to-do-list-5d959.firebasestorage.app",
            messagingSenderId: "713295970134",
            appId: "1:713295970134:web:6650db1a681742dc30a0f7",
            measurementId: "G-QG3GEXP3HC"
        };
        // ======================================================================
        
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app, auth, db, userId;
        let tasksCollection, wishlistCollection, eventsCollection;
        let tasksUnsubscribe = null;
        let wishlistUnsubscribe = null;
        let eventsUnsubscribe = null;
        let taskStatusChart = null;
        let allTasks = [];
        let allEvents = []; 
        let currentFilter = 'active'; 

        // Variabel untuk Kalender
        let currentCalendarDate = new Date();

        // --- DOM Elements ---
        const loadingOverlay = document.getElementById('loadingOverlay');
        const loginScreen = document.getElementById('loginScreen');
        const mainApp = document.getElementById('mainApp');
        const loginBtn = document.getElementById('loginWithGoogleBtn');
        const loginErrorEl = document.getElementById('loginError');
        const logoutBtn = document.getElementById('logoutBtn');
        const authStatusEl = document.getElementById('authStatus');
        const userAvatarEl = document.getElementById('userAvatar');
        const userNameEl = document.getElementById('userName');
        
        // Tabs
        const tabs = document.querySelectorAll('.nav-tab');
        const tabContents = document.querySelectorAll('.tab-content');

        // Clock
        const clockEl = document.getElementById('clockEl');
        const dateEl = document.getElementById('dateEl');

        // Task Elements
        const taskModal = document.getElementById('taskModal');
        const showTaskModalBtn = document.getElementById('showTaskModal');
        const closeTaskModalBtn = document.getElementById('closeTaskModal');
        const taskForm = document.getElementById('taskForm');
        const taskErrorEl = document.getElementById('taskError'); 
        const taskListEl = document.getElementById('taskList');
        const noTasksEl = document.getElementById('noTasks');
        const totalTasksEl = document.getElementById('totalTasks');
        const pendingTasksEl = document.getElementById('pendingTasks');
        const inProgressTasksEl = document.getElementById('inProgressTasks');
        const completedTasksEl = document.getElementById('completedTasks');
        const deadlineWarningEl = document.getElementById('deadlineWarning');
        const deadlineWarningCard = document.getElementById('filterDeadline');
        const taskTimeInput = document.getElementById('taskTime'); // Input jam baru

        // Wishlist Elements
        const wishlistModal = document.getElementById('wishlistModal');
        const showWishlistModalBtn = document.getElementById('showWishlistModal');
        const closeWishlistModalBtn = document.getElementById('closeWishlistModal');
        const wishlistForm = document.getElementById('wishlistForm');
        const wishlistGridEl = document.getElementById('wishlistGrid');
        const noWishlistItemsEl = document.getElementById('noWishlistItems');
        const wishlistTotalEl = document.getElementById('wishlistTotal');

        // Upcoming Events
        const upcomingEventsListEl = document.getElementById('upcomingEventsList');
        const noUpcomingEventsEl = document.getElementById('noUpcomingEvents');

        // Calendar Elements
        const calendarGridEl = document.getElementById('calendarGrid');
        const currentMonthYearEl = document.getElementById('currentMonthYear');
        const prevMonthBtn = document.getElementById('prevMonth');
        const nextMonthBtn = document.getElementById('nextMonth');

        // Event Modal Elements
        const eventModal = document.getElementById('eventModal');
        const closeEventModalBtn = document.getElementById('closeEventModalBtn');
        const eventForm = document.getElementById('eventForm');
        const eventModalTitle = document.getElementById('eventModalTitle');
        const eventDateInput = document.getElementById('eventDate');
        const eventNameInput = document.getElementById('eventName');
        const eventTimeInput = document.getElementById('eventTime');
        const eventRepeatInput = document.getElementById('eventRepeat');
        const eventErrorEl = document.getElementById('eventError');
        const deleteEventBtn = document.getElementById('deleteEventBtn');

        // Gemini Elements (Dihapus)

        // --- Initialization ---
        async function initializeFirebase() {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Pasang listener tombol login SEKARANG, jangan menunggu login.
                loginBtn.addEventListener('click', handleGoogleLogin);

                // Listener utama status otentikasi
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        mainApp.classList.remove('hidden');
                        loginScreen.classList.add('hidden');
                        loadingOverlay.style.display = 'none';
                        userAvatarEl.src = user.photoURL || 'https://placehold.co/40x40/E2E8F0/64748B?text=A';
                        userNameEl.textContent = user.displayName || 'Pengguna';
                        authStatusEl.classList.remove('hidden');
                        initializeAppLogic();
                    } else {
                        userId = null;
                        mainApp.classList.add('hidden');
                        loginScreen.classList.remove('hidden');
                        loadingOverlay.style.display = 'none';
                        authStatusEl.classList.add('hidden');
                        cleanupListeners();
                    }
                });

            } catch (error) {
                console.error("Firebase initialization error:", error);
                loadingOverlay.innerHTML = '<p class="text-red-500">Gagal memuat Firebase. Cek konsol.</p>';
            }
        }

        // --- Main App Logic ---
        function initializeAppLogic() {
            if (!userId) return;

            // Define collection paths
            const userArtifactsPath = `/artifacts/${appId}/users/${userId}`;
            tasksCollection = collection(db, `${userArtifactsPath}/tasks`);
            wishlistCollection = collection(db, `${userArtifactsPath}/wishlist`);
            eventsCollection = collection(db, `${userArtifactsPath}/events`);

            // Setup Listeners
            setupTabListeners();
            setupModalListeners();
            setupFormListeners(); 
            setupFilterListeners();
            setupCalendarListeners(); 
            
            updateFilterButtons(); 
            
            // Attach real-time listeners
            attachTaskListener();
            attachWishlistListener();
            attachEventsListener(); 
            
            updateClock();
            setInterval(updateClock, 1000); 

            renderCalendar();
        }

        // --- Authentication Logic ---
        async function handleGoogleLogin() {
            const provider = new GoogleAuthProvider();
            try {
                loginErrorEl.classList.add('hidden');
                await signInWithPopup(auth, provider);
            } catch (error) {
                console.error("Google sign-in error:", error);
                loginErrorEl.textContent = `Login Gagal: ${error.message}`;
                loginErrorEl.classList.remove('hidden');
            }
        }

        async function handleLogout() {
            try {
                await signOut(auth);
            } catch (error) {
                console.error("Logout error:", error);
            }
        }

        // --- Listener Cleanup ---
        function cleanupListeners() {
            if (tasksUnsubscribe) tasksUnsubscribe();
            if (wishlistUnsubscribe) wishlistUnsubscribe();
            if (eventsUnsubscribe) eventsUnsubscribe(); 
            tasksUnsubscribe = null;
            wishlistUnsubscribe = null;
            eventsUnsubscribe = null;
            allTasks = [];
            allEvents = []; 
            if (taskStatusChart) {
                taskStatusChart.destroy();
                taskStatusChart = null;
            }
        }

        // --- Event Listeners Setup ---
        function setupTabListeners() {
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    tabs.forEach(t => t.classList.remove('bg-blue-600', 'dark:bg-blue-500', 'text-white'));
                    tabs.forEach(t => t.classList.add('text-gray-700', 'dark:text-gray-300', 'hover:bg-gray-200', 'dark:hover:bg-gray-700'));
                    tab.classList.add('bg-blue-600', 'dark:bg-blue-500', 'text-white');
                    tab.classList.remove('text-gray-700', 'dark:text-gray-300', 'hover:bg-gray-200', 'dark:hover:bg-gray-700');

                    const target = tab.dataset.tab;
                    tabContents.forEach(content => {
                        if (content.id === target) {
                            content.classList.remove('hidden');
                        } else {
                            content.classList.add('hidden');
                        }
                    });
                });
            });
        }

        function setupModalListeners() {
            showTaskModalBtn.addEventListener('click', () => taskModal.showModal());
            closeTaskModalBtn.addEventListener('click', () => {
                taskModal.close();
                taskErrorEl.classList.add('hidden'); 
            });
            taskModal.addEventListener('click', (e) => {
                if (e.target === taskModal) {
                    taskModal.close();
                    taskErrorEl.classList.add('hidden');
                }
            });

            showWishlistModalBtn.addEventListener('click', () => wishlistModal.showModal());
            closeWishlistModalBtn.addEventListener('click', () => wishlistModal.close());
            wishlistModal.addEventListener('click', (e) => {
                if (e.target === wishlistModal) wishlistModal.close();
            });

            // Listener untuk Event Modal (dari kalender)
            closeEventModalBtn.addEventListener('click', () => {
                eventModal.close();
                eventErrorEl.classList.add('hidden');
            });
            eventModal.addEventListener('click', (e) => {
                if (e.target === eventModal) {
                    eventModal.close();
                    eventErrorEl.classList.add('hidden');
                }
            });
            deleteEventBtn.addEventListener('click', handleDeleteEvent);

            logoutBtn.addEventListener('click', handleLogout);
        }

        function setupFormListeners() {
            taskForm.addEventListener('submit', handleTaskSubmit);
            wishlistForm.addEventListener('submit', handleWishlistSubmit);
            eventForm.addEventListener('submit', handleEventSubmit); 
        }

        function setupCalendarListeners() {
            prevMonthBtn.addEventListener('click', () => {
                currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1);
                renderCalendar();
            });
            nextMonthBtn.addEventListener('click', () => {
                currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1);
                renderCalendar();
            });
        }

        function setupFilterListeners() {
            document.getElementById('filterAll').addEventListener('click', () => setFilter('all'));
            document.getElementById('filterPending').addEventListener('click', () => setFilter('pending'));
            document.getElementById('filterInProgress').addEventListener('click', () => setFilter('in-progress'));
            document.getElementById('filterCompleted').addEventListener('click', () => setFilter('completed'));
            document.getElementById('filterDeadline').addEventListener('click', () => setFilter('deadline'));
        }

        function setFilter(filter) {
            currentFilter = filter;
            renderFilteredTasks();
            updateFilterButtons();
        }

        function updateFilterButtons() {
            const filterCards = document.querySelectorAll('.filter-card');
            filterCards.forEach(card => {
                card.classList.remove('ring-2', 'ring-blue-500', 'ring-yellow-500', 'ring-green-500', 'ring-red-500'); 
                
                if (card.id === 'filterPending') card.classList.add('hover:ring-yellow-500');
                else if (card.id === 'filterInProgress') card.classList.add('hover:ring-blue-500');
                else if (card.id === 'filterCompleted') card.classList.add('hover:ring-green-500');
                else if (card.id === 'filterDeadline') card.classList.add('hover:ring-red-500');
                else if (card.id === 'filterAll') card.classList.add('hover:ring-blue-500');
            });

            let activeCard;
            if (currentFilter === 'all') activeCard = document.getElementById('filterAll');
            else if (currentFilter === 'pending') activeCard = document.getElementById('filterPending');
            else if (currentFilter === 'in-progress') activeCard = document.getElementById('filterInProgress');
            else if (currentFilter === 'completed') activeCard = document.getElementById('filterCompleted');
            else if (currentFilter === 'deadline') activeCard = document.getElementById('filterDeadline');
            
            if (activeCard) {
                activeCard.classList.remove('hover:ring-yellow-500', 'hover:ring-blue-500', 'hover:ring-green-500', 'hover:ring-red-500');
                
                if (currentFilter === 'pending') activeCard.classList.add('ring-2', 'ring-yellow-500');
                else if (currentFilter === 'in-progress') activeCard.classList.add('ring-2', 'ring-blue-500');
                else if (currentFilter === 'completed') activeCard.classList.add('ring-2', 'ring-green-500');
                else if (currentFilter === 'deadline') activeCard.classList.add('ring-2', 'ring-red-500');
                else if (currentFilter === 'all') activeCard.classList.add('ring-2', 'ring-blue-500');
            }
        }

        // --- Clock Logic ---
        function updateClock() {
            const now = new Date();
            const timeStr = now.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
            const dateStr = now.toLocaleDateString('id-ID', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
            
            clockEl.textContent = timeStr;
            dateEl.textContent = dateStr;

            // Periksa event mendatang setiap menit
            if (now.getSeconds() === 0) {
                renderUpcomingEvents();
            }
        }

        // --- Task Logic ---
        function attachTaskListener() {
            if (tasksUnsubscribe) tasksUnsubscribe(); 
            
            const q = query(tasksCollection);
            tasksUnsubscribe = onSnapshot(q, (snapshot) => {
                const tasks = [];
                snapshot.forEach(doc => {
                    tasks.push({ id: doc.id, ...doc.data() });
                });
                allTasks = tasks; 
                renderFilteredTasks(); 
                renderCalendar(); 
                renderUpcomingEvents(); // PERUBAHAN: Update upcoming list saat task berubah
            }, (error) => {
                console.error("Error fetching tasks:", error);
            });
        }

        async function handleTaskSubmit(e) {
            e.preventDefault();
            taskErrorEl.classList.add('hidden'); 
            const formData = new FormData(taskForm);
            const taskName = formData.get('taskName');

            if (!taskName || taskName.trim() === '') {
                taskErrorEl.textContent = 'Nama Task tidak boleh kosong.';
                taskErrorEl.classList.remove('hidden');
                return; 
            }

            const deadline = formData.get('taskDeadline'); 
            const taskTime = formData.get('taskTime') || "00:00"; // PERUBAHAN: Simpan jam, default 00:00

            const task = {
                name: taskName, 
                notes: formData.get('taskNotes'),
                driveLink: formData.get('taskDriveLink'),
                status: formData.get('taskStatus'),
                deadline: deadline ? deadline : null,
                time: taskTime, // PERUBAHAN: Menyimpan jam
                createdAt: serverTimestamp()
            };

            try {
                await addDoc(tasksCollection, task);
                taskForm.reset();
                taskErrorEl.classList.add('hidden'); 
                taskModal.close();
            } catch (error) {
                console.error("Error adding task:", error);
                taskErrorEl.textContent = `Gagal menyimpan: ${error.message}`;
                taskErrorEl.classList.remove('hidden');
            }
        }

        function renderFilteredTasks() {
            let tasksToRender = [];
            const now = new Date().getTime();
            const twoDaysInMs = 2 * 24 * 60 * 60 * 1000;

            if (currentFilter === 'all') {
                tasksToRender = allTasks;
            } else if (currentFilter === 'active') {
                tasksToRender = allTasks.filter(task => task.status === 'pending' || task.status === 'in-progress');
            } else if (currentFilter === 'deadline') {
                tasksToRender = allTasks.filter(task => {
                    if (task.deadline && task.status !== 'completed') {
                        const deadlineTime = new Date(task.deadline).getTime();
                        return deadlineTime <= (now + twoDaysInMs); // Nearing or passed
                    }
                    return false;
                });
            } else {
                tasksToRender = allTasks.filter(task => task.status === currentFilter);
            }

            updateDashboardAndChart(allTasks); 
            renderTaskList(tasksToRender); 
        }

        function updateDashboardAndChart(tasks) {
            let pending = 0;
            let inProgress = 0;
            let completed = 0;
            let deadlineWarnings = 0;
            const twoDaysInMs = 2 * 24 * 60 * 60 * 1000;
            const now = new Date().getTime();

            tasks.forEach(task => {
                if (task.deadline && task.status !== 'completed') {
                    // Perlu konversi tanggal yang benar, tambahkan 'T00:00:00' agar konsisten
                    const deadlineTime = new Date(task.deadline + 'T00:00:00').getTime();
                    
                    if (deadlineTime <= (now + twoDaysInMs)) {
                        deadlineWarnings++;
                    }
                }
                if (task.status === 'pending') pending++;
                if (task.status === 'in-progress') inProgress++;
                if (task.status === 'completed') completed++;
            });

            totalTasksEl.textContent = tasks.length;
            pendingTasksEl.textContent = pending;
            inProgressTasksEl.textContent = inProgress;
            completedTasksEl.textContent = completed;
            deadlineWarningEl.textContent = deadlineWarnings;

            if (deadlineWarnings > 0) {
                deadlineWarningCard.classList.add('ring-2', 'ring-red-500');
            } else {
                deadlineWarningCard.classList.remove('ring-2', 'ring-red-500');
            }
            if (currentFilter !== 'deadline' && !deadlineWarningCard.classList.contains('hover:ring-red-500')) {
                deadlineWarningCard.classList.add('hover:ring-red-500');
            }

            updateTaskChart(pending, inProgress, completed);
        }

        function renderTaskList(tasks) {
            taskListEl.innerHTML = '';

            if (tasks.length === 0) {
                noTasksEl.classList.remove('hidden');
                if (currentFilter === 'active') {
                    noTasksEl.textContent = 'Tidak ada task aktif. Selamat!';
                } else if (currentFilter === 'all') {
                    noTasksEl.textContent = 'Belum ada task. Silakan tambahkan!';
                } else {
                    noTasksEl.textContent = 'Tidak ada task untuk filter ini.';
                }
            } else {
                noTasksEl.classList.add('hidden');
                tasks.sort((a, b) => {
                    const aDate = a.deadline ? new Date(a.deadline) : null;
                    const bDate = b.deadline ? new Date(b.deadline) : null;

                    if (aDate && bDate) return aDate - bDate; 
                    if (!aDate && bDate) return 1; 
                    if (aDate && !bDate) return -1; 
                    return 0; 
                });
            }

            const now = new Date().getTime();
            const twoDaysInMs = 2 * 24 * 60 * 60 * 1000;

            tasks.forEach(task => {
                let isNearingDeadline = false;
                if (task.deadline && task.status !== 'completed') {
                    const deadlineTime = new Date(task.deadline + 'T00:00:00').getTime();
                    if (deadlineTime <= (now + twoDaysInMs)) {
                        isNearingDeadline = true;
                    }
                }

                const taskEl = document.createElement('div');
                taskEl.className = `bg-white dark:bg-gray-800 p-4 rounded-lg shadow-md flex flex-col md:flex-row md:items-center justify-between gap-4 ${isNearingDeadline ? 'ring-2 ring-red-500' : ''}`;
                
                const statusColor = {
                    'pending': 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200',
                    'in-progress': 'bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200',
                    'completed': 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200'
                };

                let formattedDeadline = '<i>Tidak ada deadline</i>';
                if (task.deadline) {
                    const deadlineDate = new Date(task.deadline + 'T00:00:00'); // Konsistensi Timezone
                    formattedDeadline = deadlineDate.toLocaleDateString('id-ID', { year: 'numeric', month: 'long', day: 'numeric' });
                }

                taskEl.innerHTML = `
                    <div class="flex-1 min-w-0"> 
                        <div class="flex items-center justify-between">
                            <h5 class="text-lg font-semibold">${task.name}</h5>
                            <div class="flex items-center gap-2">
                                <span class="text-xs font-medium px-2.5 py-0.5 rounded-full ${statusColor[task.status]}">${task.status}</span>
                                <button class="task-toggle-btn text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 p-1" title="Toggle notes">
                                    <svg class="w-5 h-5 transition-transform transform" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" />
                                    </svg>
                                </button>
                            </div>
                        </div>
                        <p class="note-snippet text-sm text-gray-500 dark:text-gray-400 mt-1 truncate">
                            ${task.notes || '<i>Tidak ada notes</i>'}
                        </p>
                        <div class="task-details-content mt-2 overflow-hidden h-0">
                            <p class="text-sm text-gray-600 dark:text-gray-400 mt-1 whitespace-pre-wrap">${task.notes || '<i>Tidak ada notes</i>'}</p>
                            ${task.driveLink ? `
                            <p class="text-sm text-gray-600 dark:text-gray-400 mt-2">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4 inline-block mr-1 align-middle">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M13.19 8.688a4.5 4.5 0 011.242 7.244l-4.5 4.5a4.5 4.5 0 01-6.364-6.364l1.757-1.757m13.35-.622l1.757-1.757a4.5 4.5 0 00-6.364-6.364l-4.5 4.5a4.5 4.5 0 001.242 7.244" />
                                </svg>
                                <a href="${task.driveLink}" target="_blank" rel="noopener noreferrer" class="text-blue-500 hover:underline align-middle">
                                    Link Google Drive
                                </a>
                            </p>
                            ` : ''}
                            <p class="text-sm font-medium ${isNearingDeadline ? 'text-red-500' : 'text-gray-500'} dark:text-gray-400 mt-2">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4 inline-block mr-1">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 012.25-2.25h13.5A2.25 2.25 0 0121 7.5v11.25m-18 0A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75m-18 0v-7.5A2.25 2.25 0 015.25 9h13.5A2.25 2.25 0 0121 11.25v7.5" />
                                </svg>
                                Deadline: ${formattedDeadline}
                                ${task.time && task.time !== '00:00' ? ` | Jam: ${task.time}` : ''}
                            </p>
                        </div>
                    </div>
                    <div class="flex-shrink-0 flex items-center gap-2">
                        <select data-id="${task.id}" class="task-status-select bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500">
                            <option value="pending" ${task.status === 'pending' ? 'selected' : ''}>Pending</option>
                            <option value="in-progress" ${task.status === 'in-progress' ? 'selected' : ''}>In Progress</option>
                            <option value="completed" ${task.status === 'completed' ? 'selected' : ''}>Completed</option>
                        </select>
                        <button data-id="${task.id}" class="delete-task-btn text-gray-400 hover:text-red-500 dark:hover:text-red-400 p-2">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12.56 0c-.34.053-.68.107-1.022.166m11.538 0l-1.06-1.06a1.5 1.5 0 00-2.12 0l-1.06 1.06m-2.122 0l-1.06-1.06a1.5 1.5 0 00-2.12 0l-1.06 1.06m7.424 0l-3.71-3.71a1.5 1.5 0 00-2.12 0L6.63 5.79M15 11.25l-3-3m0 0l-3 3m3-3v7.5" />
                            </svg>
                        </button>
                    </div>
                `;
                taskListEl.appendChild(taskEl);
            });
            
            document.querySelectorAll('.delete-task-btn').forEach(btn => {
                btn.addEventListener('click', () => deleteTask(btn.dataset.id));
            });
            document.querySelectorAll('.task-status-select').forEach(select => {
                select.addEventListener('change', (e) => updateTaskStatus(select.dataset.id, e.target.value));
            });
            document.querySelectorAll('.task-toggle-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const button = e.currentTarget;
                    const flex1 = button.closest('.flex-1'); 
                    const content = flex1.querySelector('.task-details-content');
                    const snippet = flex1.querySelector('.note-snippet');
                    const icon = button.querySelector('svg');
                    
                    if (content.classList.contains('h-0')) {
                        content.classList.remove('h-0', 'overflow-hidden');
                        snippet.classList.add('hidden'); 
                        icon.classList.add('rotate-180');
                    } else {
                        content.classList.add('h-0', 'overflow-hidden');
                        snippet.classList.remove('hidden'); 
                        icon.classList.remove('rotate-180');
                    }
                });
            });
        }

        async function deleteTask(id) {
            if (!confirm("Apakah Anda yakin ingin menghapus task ini?")) {
                return;
            }
            try {
                await deleteDoc(doc(tasksCollection, id));
            } catch (error) {
                console.error("Error deleting task:", error);
            }
        }
        
        async function updateTaskStatus(id, status) {
            try {
                const taskRef = doc(tasksCollection, id);
                await updateDoc(taskRef, { status: status });
            } catch (error) {
                console.error("Error updating task status:", error);
            }
        }

        // --- Task Chart Logic ---
        function updateTaskChart(pending, inProgress, completed) {
            const ctx = document.getElementById('taskStatusChart').getContext('2d');
            const data = {
                labels: ['Pending', 'In Progress', 'Completed'],
                datasets: [{
                    label: 'Task Status',
                    data: [pending, inProgress, completed],
                    backgroundColor: [ 'rgb(234, 179, 8)', 'rgb(59, 130, 246)', 'rgb(34, 197, 94)' ],
                    hoverOffset: 4
                }]
            };
            const options = {
                responsive: true, maintainAspectRatio: false, rotation: -90, circumference: 180, cutout: '70%',
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: { color: '#f3f4f6', font: { size: 10 }, padding: 10 }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.label || '';
                                if (label) { label += ': '; }
                                if (context.parsed !== null) { label += context.parsed + ' task(s)'; }
                                return label;
                            }
                        }
                    }
                }
            };
            if (taskStatusChart) {
                taskStatusChart.data.datasets[0].data = [pending, inProgress, completed];
                taskStatusChart.update();
            } else {
                taskStatusChart = new Chart(ctx, { type: 'doughnut', data: data, options: options });
            }
        }

        // --- Wishlist Logic ---
        function attachWishlistListener() {
            if (wishlistUnsubscribe) wishlistUnsubscribe();
            const q = query(wishlistCollection);
            wishlistUnsubscribe = onSnapshot(q, (snapshot) => {
                const items = [];
                snapshot.forEach(doc => {
                    items.push({ id: doc.id, ...doc.data() });
                });
                renderWishlist(items);
            }, (error) => {
                console.error("Error fetching wishlist:", error);
            });
        }

        async function handleWishlistSubmit(e) {
            e.preventDefault();
            const formData = new FormData(wishlistForm);
            const itemName = formData.get('productName');
            if (!itemName || itemName.trim() === '') {
                alert('Nama Produk tidak boleh kosong.'); 
                return;
            }
            const item = {
                name: itemName,
                link: formData.get('productLink'),
                price: Number(formData.get('productPrice')) || 0,
                createdAt: serverTimestamp()
            };
            try {
                await addDoc(wishlistCollection, item);
                wishlistForm.reset();
                wishlistModal.close();
            } catch (error) {
                console.error("Error adding wishlist item:", error);
                alert(`Gagal menyimpan: ${error.message}`);
            }
        }

        function renderWishlist(items) {
            wishlistGridEl.innerHTML = '';
            let totalHarga = 0; 
            if (items.length === 0) {
                noWishlistItemsEl.classList.remove('hidden');
            } else {
                noWishlistItemsEl.classList.add('hidden');
                items.sort((a, b) => (b.createdAt?.toDate() || 0) - (a.createdAt?.toDate() || 0));
            }
            items.forEach(item => {
                totalHarga += item.price; 
                const itemEl = document.createElement('div');
                itemEl.className = 'bg-white dark:bg-gray-800 p-4 rounded-lg shadow-md flex flex-col justify-between';
                const formattedPrice = new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(item.price);
                itemEl.innerHTML = `
                    <div>
                        <div class="flex justify-between items-start">
                            <h5 class="text-lg font-semibold mb-2">${item.name}</h5>
                            <button data-id="${item.id}" class="delete-wishlist-btn text-gray-400 hover:text-red-500 dark:hover:text-red-400 p-1">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                                </svg>
                            </button>
                        </div>
                        <p class="text-xl font-bold text-blue-600 dark:text-blue-400 mb-4">${formattedPrice}</p>
                    </div>
                    <a href="${item.link}" target="_blank" rel="noopener noreferrer" class="w-full text-center bg-green-500 hover:bg-green-600 text-white font-medium py-2 px-4 rounded-lg">
                        Beli Sekarang
                    </a>
                `;
                wishlistGridEl.appendChild(itemEl);
            });
            document.querySelectorAll('.delete-wishlist-btn').forEach(btn => {
                btn.addEventListener('click', () => deleteWishlistItem(btn.dataset.id));
            });
            const formattedTotal = new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(totalHarga);
            wishlistTotalEl.textContent = formattedTotal;
        }

        async function deleteWishlistItem(id) {
            if (confirm('Apakah Anda yakin ingin menghapus barang ini dari wishlist?')) {
                try {
                    await deleteDoc(doc(wishlistCollection, id));
                } catch (error) {
                    console.error("Error deleting wishlist item:", error);
                }
            }
        }
        
        // --- LOGIKA BARU: Kalender & Event ---

        function attachEventsListener() {
            if (eventsUnsubscribe) eventsUnsubscribe();
            const q = query(eventsCollection);
            eventsUnsubscribe = onSnapshot(q, (snapshot) => {
                const events = [];
                snapshot.forEach(doc => {
                    events.push({ id: doc.id, ...doc.data() });
                });
                allEvents = events;
                renderCalendar(); 
                renderUpcomingEvents(); 
            }, (error) => {
                console.error("Error fetching events:", error);
            });
        }

        function getTodayString() {
            const now = new Date();
            const y = now.getFullYear();
            const m = String(now.getMonth() + 1).padStart(2, '0');
            const d = String(now.getDate()).padStart(2, '0');
            return `${y}-${m}-${d}`; // "YYYY-MM-DD"
        }

        function renderCalendar() {
            calendarGridEl.innerHTML = '';
            currentMonthYearEl.textContent = currentCalendarDate.toLocaleDateString('id-ID', { month: 'long', year: 'numeric' });
            const year = currentCalendarDate.getFullYear();
            const month = currentCalendarDate.getMonth();
            const firstDayOfMonth = new Date(year, month, 1).getDay(); // 0=Minggu, 1=Senin
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            for (let i = 0; i < firstDayOfMonth; i++) {
                calendarGridEl.innerHTML += `<div class="calendar-day other-month"></div>`;
            }
            const todayStr = getTodayString();
            for (let day = 1; day <= daysInMonth; day++) {
                const dayEl = document.createElement('div');
                dayEl.className = 'calendar-day';
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                if (dateStr === todayStr) {
                    dayEl.classList.add('today');
                }
                dayEl.dataset.date = dateStr;
                dayEl.innerHTML = `<span class="day-number">${day}</span><div class="event-dot-container"></div>`;
                
                // Tambahkan dots untuk task
                const tasksOnThisDay = allTasks.filter(task => task.deadline === dateStr && task.status !== 'completed');
                tasksOnThisDay.forEach(() => {
                    dayEl.querySelector('.event-dot-container').innerHTML += `<div class="event-dot event-dot-task"></div>`;
                });

                // Tambahkan dots untuk event
                const dayOfWeek = new Date(dateStr + 'T00:00:00').getDay();
                const eventsOnThisDay = allEvents.filter(event => {
                    if (event.repeatType === 'once' && event.date === dateStr) return true;
                    if (event.repeatType === 'daily') return true;
                    // Cek weekly
                    const eventDate = new Date(event.date + 'T00:00:00');
                    if (event.repeatType === 'weekly' && eventDate.getDay() === dayOfWeek && eventDate.getTime() <= new Date(dateStr + 'T00:00:00').getTime()) {
                        return true;
                    }
                    return false;
                });
                eventsOnThisDay.forEach(event => {
                    dayEl.querySelector('.event-dot-container').innerHTML += `<div class="event-dot event-dot-event" data-event-id="${event.id}" title="${event.name}"></div>`;
                });

                dayEl.addEventListener('click', (e) => {
                    const targetDot = e.target.closest('.event-dot-event');
                    if (targetDot) {
                        e.stopPropagation(); 
                        openEventModal(dateStr, targetDot.dataset.eventId);
                    } else {
                        openEventModal(dateStr);
                    }
                });
                calendarGridEl.appendChild(dayEl);
            }
        }

        async function openEventModal(date, eventId = null) {
            eventForm.reset();
            eventErrorEl.classList.add('hidden');
            eventForm.dataset.eventId = '';
            eventDateInput.value = date;
            if (eventId) {
                eventModalTitle.textContent = 'Edit Event';
                deleteEventBtn.classList.remove('hidden');
                eventForm.dataset.eventId = eventId;
                try {
                    const eventRef = doc(eventsCollection, eventId);
                    const eventSnap = await getDoc(eventRef);
                    if (eventSnap.exists()) {
                        const event = eventSnap.data();
                        eventNameInput.value = event.name;
                        eventTimeInput.value = event.time;
                        eventRepeatInput.value = event.repeatType;
                    } else {
                        throw new Error("Event tidak ditemukan.");
                    }
                } catch (error) {
                    console.error("Error fetching event:", error);
                    eventErrorEl.textContent = error.message;
                    eventErrorEl.classList.remove('hidden');
                    return;
                }
            } else {
                eventModalTitle.textContent = 'Tambah Event Baru';
                deleteEventBtn.classList.add('hidden');
            }
            eventModal.showModal();
        }

        async function handleEventSubmit(e) {
            e.preventDefault();
            eventErrorEl.classList.add('hidden');
            const eventId = e.target.dataset.eventId;
            const eventData = {
                name: eventNameInput.value,
                date: eventDateInput.value, // YYYY-MM-DD
                time: eventTimeInput.value, // HH:MM
                repeatType: eventRepeatInput.value, // 'once', 'daily', 'weekly'
                lastActionDate: null, // Untuk melacak 'done'/'skip'
            };
            if (!eventData.name || !eventData.time) {
                eventErrorEl.textContent = 'Nama Event dan Jam tidak boleh kosong.';
                eventErrorEl.classList.remove('hidden');
                return;
            }
            try {
                if (eventId) {
                    const eventRef = doc(eventsCollection, eventId);
                    await updateDoc(eventRef, eventData);
                } else {
                    await addDoc(eventsCollection, eventData);
                }
                eventForm.reset();
                eventModal.close();
            } catch (error) {
                console.error("Error saving event:", error);
                eventErrorEl.textContent = `Gagal menyimpan: ${error.message}`;
                eventErrorEl.classList.remove('hidden');
            }
        }

        async function handleDeleteEvent() {
            const eventId = eventForm.dataset.eventId;
            if (!eventId || !confirm("Apakah Anda yakin ingin menghapus event ini?")) {
                return;
            }
            try {
                await deleteDoc(doc(eventsCollection, eventId));
                eventModal.close();
            } catch (error) {
                console.error("Error deleting event:", error);
                eventErrorEl.textContent = `Gagal menghapus: ${error.message}`;
                eventErrorEl.classList.remove('hidden');
            }
        }

        // --- LOGIKA BARU: Upcoming Events (Menggantikan Repeated Task) ---

        function renderUpcomingEvents() {
            const now = new Date();
            const todayDateStr = getTodayString(); // "YYYY-MM-DD"
            const todayDay = now.getDay(); // 0-6 (Minggu-Sabtu)
            const currentTimeStr = now.toTimeString().split(' ')[0].substring(0, 5); // "HH:MM"

            // 1. Dapatkan Events untuk hari ini
            const eventsDueToday = allEvents.filter(event => {
                if (event.lastActionDate === todayDateStr) return false;
                if (event.time > currentTimeStr) return false;
                
                if (event.repeatType === 'once' && event.date === todayDateStr) return true;
                if (event.repeatType === 'daily') return true;

                const eventDate = new Date(event.date + 'T00:00:00');
                if (event.repeatType === 'weekly' && eventDate.getDay() === todayDay && eventDate.getTime() <= new Date(todayDateStr + 'T00:00:00').getTime()) {
                    return true;
                }
                return false;
            }).map(event => ({ ...event, type: 'event' })); // Tandai sebagai 'event'

            // 2. Dapatkan Tasks untuk hari ini
            const tasksDueToday = allTasks.filter(task => {
                if (task.status === 'completed') return false; // Abaikan yang sudah selesai
                if (task.deadline !== todayDateStr) return false; // Bukan hari ini
                if (task.time > currentTimeStr) return false; // Belum waktunya
                return true;
            }).map(task => ({ ...task, type: 'task' })); // Tandai sebagai 'task'

            // 3. Gabungkan dan sortir
            const combinedList = [...eventsDueToday, ...tasksDueToday];
            combinedList.sort((a, b) => a.time.localeCompare(b.time));

            upcomingEventsListEl.innerHTML = '';
            if (combinedList.length === 0) {
                noUpcomingEventsEl.classList.remove('hidden');
            } else {
                noUpcomingEventsEl.classList.add('hidden');
                combinedList.forEach(item => {
                    const itemEl = document.createElement('div');
                    itemEl.className = 'bg-white dark:bg-gray-800 p-4 rounded-lg shadow-md flex items-center justify-between gap-4';
                    
                    if (item.type === 'event') {
                        // Render sebagai Event
                        itemEl.innerHTML = `
                            <div class="flex items-center gap-3">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 text-purple-500">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                                <div>
                                    <h5 class="font-semibold">${item.name}</h5>
                                    <p class="text-sm text-gray-500 dark:text-gray-400">Event pada jam ${item.time}</p>
                                </div>
                            </div>
                            <div class="flex-shrink-0 flex items-center gap-2">
                                <button data-id="${item.id}" class="complete-event-btn text-white bg-green-500 hover:bg-green-600 rounded-full p-2" title="Selesai">
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 9-13.5" />
                                    </svg>
                                </button>
                                <button data-id="${item.id}" class="skip-event-btn text-white bg-gray-400 hover:bg-gray-500 dark:bg-gray-600 dark:hover:bg-gray-500 rounded-full p-2" title="Tolak/Lewati">
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                                    </svg>
                                </button>
                            </div>
                        `;
                    } else {
                        // Render sebagai Task
                        itemEl.innerHTML = `
                            <div class="flex items-center gap-3">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 text-yellow-500">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12c0 1.268-.213 2.48-.6 3.63m-3.6-3.63v-1.979c0-.621-.504-1.125-1.125-1.125H12.375c-.621 0-1.125.504-1.125 1.125v1.979m0 0A7.497 7.497 0 0012 15a7.497 7.497 0 003-1.37m-3 1.37a7.497 7.497 0 01-3-1.37m3 1.37v1.979c0 .621.504 1.125 1.125 1.125h2.25c.621 0 1.125-.504 1.125-1.125v-1.979a7.497 7.497 0 00-3-1.37z" />
                                </svg>
                                <div>
                                    <h5 class="font-semibold">${item.name}</h5>
                                    <p class="text-sm text-gray-500 dark:text-gray-400">Task deadline jam ${item.time}</p>
                                </div>
                            </div>
                            <div class="flex-shrink-0 flex items-center gap-2">
                                <button data-id="${item.id}" class="complete-task-btn text-white bg-green-500 hover:bg-green-600 rounded-full p-2" title="Tandai Selesai">
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 9-13.5" />
                                    </svg>
                                </button>
                            </div>
                        `;
                    }
                    upcomingEventsListEl.appendChild(itemEl);
                });
            }

            // Tambahkan listener untuk tombol-tombol baru
            document.querySelectorAll('.complete-event-btn').forEach(btn => {
                btn.addEventListener('click', () => handleCompleteUpcomingEvent(btn.dataset.id));
            });
            document.querySelectorAll('.skip-event-btn').forEach(btn => {
                btn.addEventListener('click', () => handleSkipUpcomingEvent(btn.dataset.id));
            });
            document.querySelectorAll('.complete-task-btn').forEach(btn => {
                btn.addEventListener('click', () => updateTaskStatus(btn.dataset.id, 'completed')); // Panggil fungsi yang sudah ada
            });
        }

        async function handleCompleteUpcomingEvent(id) {
            const todayDateStr = getTodayString();
            try {
                const eventRef = doc(eventsCollection, id);
                await updateDoc(eventRef, { lastActionDate: todayDateStr }); // Set 'done' untuk hari ini
            } catch (error) {
                console.error("Error completing event:", error);
            }
        }

        async function handleSkipUpcomingEvent(id) {
            const todayDateStr = getTodayString();
            try {
                const eventRef = doc(eventsCollection, id);
                await updateDoc(eventRef, { lastActionDate: todayDateStr }); // Set 'skipped' untuk hari ini
            } catch (error) {
                console.error("Error skipping event:", error);
            }
        }
        
        // --- Start App ---
        initializeFirebase();

    </script>
</body>
</html>